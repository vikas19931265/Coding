<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <!-- MOTW-DISABLED saved from url=(0014)about:internet -->
    <title>Running Code in an Entirely New Bundle</title>
    <link rel="StyleSheet" href="css/transactions.css" type="text/css" media="all" />
    <link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" />
    <link rel="StyleSheet" href="css/css-guidewire-extra.css" type="text/css" media="all" />
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/context.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/towwhdir.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/wwhpagef.js"></script>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        var  WebWorksRootPath = "";
      // -->
    </script>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        // Set reference to top level help frame
        //
        var  WWHFrame = WWHGetWWHFrame("", true);
      // -->
    </script>
    <script type="text/javascript" language="JavaScript1.2" src="scripts/expand.js"></script>
    <!-- THE FOLLOWING IS A GUIDEWIRE STYLE DEFINITION FOR THE LINK TO THIS FEATURE -->
    <link rel="StyleSheet" href="css/css-guidewire-extra.css" type="text/css" media="all" />
    <!-- THE FOLLOWING IS A GUIDEWIRE GSCRIPT FUNCTION FOR THE LINK TO THIS FEATURE -->
    <script type="text/javascript">
function guidewire_selectall()
{
var text_val=eval("document.linktothisurlform.urlfield");
text_val.focus();
text_val.select();
}
</script>
  </head>
  <body onLoad="WWHUpdate();" onUnload="WWHUnload();" onKeyDown="WWHHandleKeyDown((document.all||document.getElementById||document.layers)?event:null);" onKeyPress="WWHHandleKeyPress((document.all||document.getElementById||document.layers)?event:null);" onKeyUp="WWHHandleKeyUp((document.all||document.getElementById||document.layers)?event:null);">
    <!-- THE FOLLOWING IS A GUIDEWIRE DIV FOR THE 'LINK TO THIS' FEATURE -->
    <div id="linkToThisPage" class="popup" style="display: none;">
      <div class="popupTitle">Link Directly to This Page 
           <a href="#" onclick="var thePopup = getElementById('linkToThisPage');thePopup.style.display='none';return false;"><img class="popupClosebox" src="wwhelp/wwhimpl/common/images/close.gif" /></a></div>
      <div style="padding:6px;">
        <div class="popupText" id="linkToThisPageBookmark">An error has occurred if you see this messsage.</div>
        <form name="linktothisurlform" method="post" action="" style="width:275px;margin:0px">
          <input type="text" class="popupURLText" id="linkToThisPageURL" name="urlfield" rows="1" cols="55" onClick="guidewire_selectall();" onFocus="guidewire_selectall();"></input>
        </form>
      </div>
    </div>
    <br />
    <div class="WebWorks_Breadcrumbs" style="text-align: left;">
      <span>Gosu Reference Guide</span> : 
    <span class="WebWorks_Breadcrumbs" style="text-align: left;"><a class="WebWorks_Breadcrumb_Link" href="transactions.22.01.html#1634152">Bundles and Database Transactions</a> : Running Code in an Entirely New Bundle</span></div>
    <hr align="left" />
    <blockquote>
      <h3 class="H1_-_Heading_1"><a name="1634152">Running Code in an Entirely New Bundle</a></h3>
      <div class="B_-_Body"><a name="1634153">Typical Gosu code interacts with database transactions by using the current bundle set up for rules execution, plugin code, or PCF user interface code. In such cases, ClaimCenter automatically manage the low level parts of database transactions. Only in rare cases your code must create or commit a bundle explicitly, such as batch processes, WS-I web service implementation classes, and actions triggered from workflows.</a></div>
      <div class="B_-_Body"><a name="1558771">In rare cases, you can run Gosu code in an entirely new bundle. In other words, you sometimes must create a different transaction. You might need a new transaction because there is no current bundle or because you need changes in a different transaction from the current transaction.</a></div>
      <div class="B_-_Body"><a name="1558814">Create your own bundle only in the following cases:</a></div>
      <div class="BI_-_Bullet_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI_-_Bullet_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI_-_Bullet_Item_inner"><a name="1558633">If your code modifies entities to commit independent of the </a><span class="s_-_strong">success</span> of the surrounding code. For example, some workflow asynchronous actions or unusual PCF user interface code might need to create a new bundle.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI_-_Bullet_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI_-_Bullet_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI_-_Bullet_Item_inner"><a name="1558706">If your code represents a separate asynchronous actions from surrounding code</a></div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI_-_Bullet_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <div class="BI_-_Bullet_Item_inner" style="width: 15pt; white-space: nowrap">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI_-_Bullet_Item_inner"><a name="1558596">If your Gosu calls Java code that spawns a new thread within the server, such as a timer or scheduled event. It is important that no two threads share a bundle.</a></div>
            </td>
          </tr>
        </table>
      </div>
      <div class="B_-_Body"><a name="1559109">To run code within a separate transaction, you must create a Gosu</a><span class="e_-_emphasis">&nbsp;block</span>, which is an in-line function that you define in-line within another function. You can pass a block to other functions to invoke as appropriate. For detailed information about blocks, see <a href="javascript:WWHClickedPopup('gosu', 'blocks.18.1.html#1445150', '');" title="Gosu Blocks">“Gosu Blocks”</a>.</div>
      <div class="B_-_Body"><a name="1558859">To create a new bundle, call the static method </a><span class="cv_-_computer_voice">runWithNewBundle</span> on the <span class="cv_-_computer_voice">gw.transaction.Transaction</span> class. As a method argument, pass a Gosu&nbsp;block that takes one argument, which is a bundle (<span class="cv_-_computer_voice">Bundle</span>). Gosu creates an entirely new bundle just for your code within the block<span class="cv_-_computer_voice">.</span> </div>
      <div class="B_-_Body"><a name="1559180">The syntax is:</a></div>
      <PRE class="CF_-_Code_First_Line"><a name="1559150">uses gw.transaction.Transaction</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1558860">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1559164">...</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1559165">&nbsp;</a></PRE>
      <PRE class="CL_-_Code_Last_Line"><a name="1559191">Transaction.runWithNewBundle( \ bundle -&gt; </a><span class="pt_-_parameter_in_table">YOUR_BLOCK_CODE_HERE</span> )</PRE>
      <div class="B_-_Body"><a name="1559192">Your Gosu code within the block can add entity instances to the bundle as appropriate using the </a><span class="cv_-_computer_voice">bundle.add(</span><span class="ps_-_parameter_in_code_snippets">entity</span><span class="cv_-_computer_voice">)</span> method. Remember to save the return result of the <span class="cv_-_computer_voice">add</span> method. See <a href="javascript:WWHClickedPopup('gosu', 'transactions.22.04.html#1611659', '');" title="Adding Entity Instances to Bundles">“Adding Entity Instances to Bundles”</a>.</div>
      <div class="B_-_Body"><a name="1559230">Gosu runs this code synchronously (immediately). If the block succeeds with no exceptions, </a><span class="cv_-_computer_voice">runWithNewBundle</span> automatically commits the new bundle after your code completes. For the most concise and easy-to-understand code, Guidewire encourages you to use this automatic commit behavior rather than committing the bundle explicitly. </div>
      <div class="B_-_Body"><a name="1635125">If your code detects error conditions, throw an exception from the Gosu block. Gosu does not commit the bundle. The bundle is discarded.</a></div>
      <div class="B_-_Body"><a name="1602437">The following example demonstrates how to create a new bundle to run code that creates a new entity instance and modifies some fields. The current transaction is an argument to the block. </a></div>
      <div class="B_-_Body"><a name="1635364">If you are adding entity instances, in typical code you do not need to use the bundle explicitly. Gosu sets the current bundle inside the block to this new block automatically. You can use the no-argument version of the </a><span class="cv_-_computer_voice">new</span> operator for entity types, which creates the object the current bundle:</div>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602440">gw.transaction.Transaction.runWithNewBundle( \b -&gt; {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602441">&nbsp;&nbsp;var me = new MyEntity()&nbsp;&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602442">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602443">&nbsp;&nbsp;me.FirstName = firstName</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602444">&nbsp;&nbsp;me.LastName = lastName</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602445">&nbsp;&nbsp;me.PrimaryAddress = address</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602446">&nbsp;&nbsp;me.EmailAddress1 = email</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602447">&nbsp;&nbsp;me.WorkPhone = workPhone</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602448">&nbsp;&nbsp;me.PrimaryPhone = primaryPhoneType</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602449">&nbsp;&nbsp;me.TaxID = taxId</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602450">&nbsp;&nbsp;me.FaxPhone = faxPhone</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602451">} )</a></PRE>
      <div class="B_-_Body"><a name="1601851">If you perform database queries, you can use the bundle reference to add entity instances to the new writable bundle. See </a><a href="javascript:WWHClickedPopup('gosu', 'transactions.22.04.html#1611659', '');" title="Adding Entity Instances to Bundles">“Adding Entity Instances to Bundles”</a>.</div>
      <div class="NW_-_Note_Warning">
        <span class="w_-_warning">WARNING  </span><a name="1636738">Only commit a bundle if you are sure it is appropriate for that programming context. Otherwise you could causes data integrity problems. For example, in Rule sets or PCF code, it is typically dangerous to commit a bundle explicitly (including with this API). Contact Customer Support if you have questions.</a></div>
      <div class="H3_-_Heading_3_outer" style="margin-left: 36pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline">
            <td>
              <h5 class="H3_-_Heading_3_inner" style="width: 18pt; white-space: nowrap"></h5>
            </td>
            <td width="100%">
              <h5 class="H3_-_Heading_3_inner"><a name="1635514">Using Variable Capturing in Your Block</a></h5>
            </td>
          </tr>
        </table>
      </div>
      <div class="B_-_Body"><a name="1635812">The following example method from a web service implementation demonstrates how to create a new bundle to call a utility function that does the core part of the work. </a></div>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601852">...</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601853">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601854">public function myAction(customerID : String) : void {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601855">&nbsp;&nbsp;Transaction.runWithNewBundle( \ bundle -&gt; MyClass.doSomething(customerID, bundle))</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601856">}</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601857">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601858">...</a></PRE>
      <div class="B_-_Body"><a name="1562945">Although this example looks simple, the block is not entirely self-contained. It uses the method argument </a><span class="cv_-_computer_voice">customerID</span><span style="font-family: &quot;Lucida Sans Typewriter&quot;; font-size: 7.0pt"> </span>for the <span class="cv_-_computer_voice">myAction</span> method even though <span class="cv_-_computer_voice">customerID</span><span style="font-family: &quot;Lucida Sans Typewriter&quot;; font-size: 7.0pt"> </span>is not declared in the scope of the block. The ability for the block to use variables from its creation context is called <span class="e_-_emphasis">variable capturing. </span>For more information about this feature, see <a href="javascript:WWHClickedPopup('gosu', 'blocks.18.4.html#1443613', '');" title="Variable Scope and Capturing Variables In Blocks">“Variable Scope and Capturing Variables In Blocks”</a>.</div>
      <div class="B_-_Body"><a name="1561559">In some cases, you might need to return information back from your block. You can do this using more advanced use of variable capturing. The following example demonstrates variable capturing by creating a local variable in the outer scope (</a><span style="font-family: &quot;Lucida Sans Typewriter&quot;; font-size: 7.0pt">myAction</span>) but then setting its value from within the block. Consequently, the outer scope can return that value as a return value from the method.</div>
      <PRE class="CM_-_Code_Middle_Line"><a name="1636587">public function myAction(customerID : String) : boolean {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1636588">    var res : boolean</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1636589">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557090">&nbsp;&nbsp;&nbsp;&nbsp;// the local variable "res" and the parameter "customerID" is captured by the block. </a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557234">&nbsp;&nbsp;&nbsp;&nbsp;// Both variables are shared between the calling function and the block</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557235">    Transaction.runWithNewBundle( \ bundle -&gt; { res = MyClass.doSomething(customerID, bundle) })</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557138">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557141">&nbsp;&nbsp;&nbsp;&nbsp;// return the value that was set in the block using the shared (captured) variable</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1553463">    return res </a></PRE>
      <PRE class="CL_-_Code_Last_Line"><a name="1553839">}</a></PRE>
      <h4 class="H2_-_Heading_2"><a name="1583029">Create Bundle For a Specific ClaimCenter User</a></h4>
      <div class="B_-_Body"><a name="1583030">The </a><span class="cv_-_computer_voice">gw.transaction.Transaction</span> class has an alternate version of the <span class="cv_-_computer_voice">runWithNewBundle</span> method to create a bundle with a specific user associated with it. This is intended for use in contexts in which there is no built-in user context, such in the startable plugins feature. The method signature is:</div>
      <div class="CS_-_Code_Single_Line"><a name="1583031">gw.transaction.Transaction.runWithNewBundle(\ bundle -&gt; </a><span class="pc_-_parameter_in_code">YOUR_BLOCK_BODY</span>, user)</div>
      <div class="B_-_Body"><a name="1583047">For that second method argument, you can pass either a </a><span class="cv_-_computer_voice">User</span> entity instance or a <span class="cv_-_computer_voice">String</span> that is the user name.</div>
      <h4 class="H2_-_Heading_2"><a name="1602225">Warning about Transaction Class Confusion</a></h4>
      <div class="B_-_Body"><a name="1602229">There is more than one </a><span class="cv_-_computer_voice">Transaction</span> type in Gosu for ClaimCenter. Do not confuse the class <span class="cv_-_computer_voice">gw.transaction.Transaction</span> with the <span class="cv_-_computer_voice">Transaction</span> entity type or type list.</div>
      <div class="B_-_Body"><a name="1602230">If you use these APIs, you might want to use a Gosu </a><span class="cv_-_computer_voice">uses</span> statement such as the following:</div>
      <div class="CS_-_Code_Single_Line"><a name="1602231">uses gw.transaction.Transaction</a></div>
      <div class="B_-_Body"><a name="1602232">This topic is about the class in the </a><span class="cv_-_computer_voice">gw.transaction</span> package, in other words: <span class="cv_-_computer_voice">gw.transaction.Transaction</span>. </div>
      <script type="text/javascript" language="JavaScript1.2">
        <!--
          // Clear related topics
          //
          WWHClearRelatedTopics();

          document.writeln(WWHRelatedTopicsInlineHTML());
        // -->
      </script>
    </blockquote>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        document.write(WWHRelatedTopicsDivTag() + WWHPopupDivTag() + WWHALinksDivTag());
      // -->
    </script>
  </body>
</html>